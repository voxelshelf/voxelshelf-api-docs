openapi: 3.1.0
info:
  title: Voxel Shelf Upload API
  version: 1.0.0
  description: |
    Public creator API for upload and publish workflows.
    This v1 contract is intentionally scoped to upload and product publish operations.
  x-docs-revision: 2026-02-24
servers:
  - url: https://api.voxelshelf.com/api
security:
  - bearerAuth: []
tags:
  - name: Uploads
    description: Upload lifecycle operations (presign, complete, status).
  - name: Products
    description: Draft and publish operations for creator products.
paths:
  /v1/uploads/presign:
    post:
      tags: [Uploads]
      summary: Request a presigned upload URL
      description: Create a pending upload and return a signed URL for direct storage upload.
      operationId: createUploadPresign
      parameters:
        - $ref: "#/components/parameters/XRequestId"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PresignUploadRequest"
            examples:
              archive:
                value:
                  filename: model.zip
                  contentType: application/zip
                  size: 1234567
                  kind: file
      responses:
        "200":
          description: Presigned URL generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PresignUploadResponse"
              examples:
                success:
                  value:
                    uploadId: upl_01J0N8R8DN6V23A44T1
                    storageKey: uploads/creator_01/upl_01J0N8R8DN6V23A44T1/model.zip
                    uploadUrl: https://storage.example.com/presigned-url
                    expiresAt: "2026-02-24T19:15:10.000Z"
                    maxBytes: 1073741824
        "400":
          $ref: "#/components/responses/ApiError"
        "401":
          $ref: "#/components/responses/ApiError"
        "403":
          $ref: "#/components/responses/ApiError"
        "429":
          $ref: "#/components/responses/ApiError"

  /v1/uploads/complete:
    post:
      tags: [Uploads]
      summary: Complete a pending upload
      description: Validate and mark a pending upload as READY.
      operationId: completeUpload
      parameters:
        - $ref: "#/components/parameters/XRequestId"
        - $ref: "#/components/parameters/IdempotencyKeyRequired"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CompleteUploadRequest"
            examples:
              minimal:
                value:
                  uploadId: upl_01J0N8R8DN6V23A44T1
      responses:
        "200":
          description: Upload marked as ready
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CompleteUploadResponse"
              examples:
                success:
                  value:
                    assetId: ast_01J0N8R8SP4M4WJQH37
                    status: READY
                    storageKey: uploads/creator_01/upl_01J0N8R8DN6V23A44T1/model.zip
                    size: 1234567
                    mime: application/zip
                    kind: file
        "400":
          $ref: "#/components/responses/ApiError"
        "401":
          $ref: "#/components/responses/ApiError"
        "403":
          $ref: "#/components/responses/ApiError"
        "409":
          $ref: "#/components/responses/ApiError"
        "410":
          $ref: "#/components/responses/ApiError"
        "429":
          $ref: "#/components/responses/ApiError"

  /v1/uploads/{id}:
    get:
      tags: [Uploads]
      summary: Get upload status
      description: Retrieve the current status and metadata for one upload.
      operationId: getUploadStatus
      parameters:
        - $ref: "#/components/parameters/XRequestId"
        - in: path
          name: id
          required: true
          description: Upload identifier.
          schema:
            type: string
      responses:
        "200":
          description: Upload found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UploadStatusResponse"
              examples:
                ready:
                  value:
                    id: upl_01J0N8R8DN6V23A44T1
                    storageKey: uploads/creator_01/upl_01J0N8R8DN6V23A44T1/model.zip
                    filename: model.zip
                    size: 1234567
                    mime: application/zip
                    kind: file
                    status: READY
                    expiresAt: "2026-02-24T19:15:10.000Z"
                    completedAt: "2026-02-24T18:17:01.000Z"
                    createdAt: "2026-02-24T18:15:10.000Z"
                    updatedAt: "2026-02-24T18:17:01.000Z"
        "401":
          $ref: "#/components/responses/ApiError"
        "404":
          $ref: "#/components/responses/ApiError"
        "429":
          $ref: "#/components/responses/ApiError"

  /v1/creator/products:
    post:
      tags: [Products]
      summary: Create a product draft
      description: Create a draft product from uploaded assets.
      operationId: createCreatorProductDraft
      parameters:
        - $ref: "#/components/parameters/XRequestId"
        - $ref: "#/components/parameters/IdempotencyKeyRequired"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductCreateRequest"
            examples:
              minimal:
                value:
                  title: API Draft Model
                  description: Model created via public API.
                  category: Home & Decor
                  subcategory: Decor & Lighting
                  printMaterials: [PLA]
                  supports: Optional
                  difficulty: Easy
                  isPresupported: false
                  license: Personal
                  price: 12
                  images:
                    - url: https://images.voxelshelf.com/demo.jpg
                      alt: Preview
                  files:
                    - storageKey: uploads/creator_01/upl_01/model.zip
                      filename: model.zip
                      size: 1234567
                      mime: application/zip
                      kind: Archive
      responses:
        "200":
          description: Draft created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductDraftResponse"
              examples:
                success:
                  value:
                    id: prod_01J0NA23WT95D8HMRP6
                    slug: api-draft-model
                    status: DRAFT
        "400":
          $ref: "#/components/responses/ApiError"
        "401":
          $ref: "#/components/responses/ApiError"
        "403":
          $ref: "#/components/responses/ApiError"
        "409":
          $ref: "#/components/responses/ApiError"
        "429":
          $ref: "#/components/responses/ApiError"

  /v1/creator/products/{id}:
    patch:
      tags: [Products]
      summary: Update a product draft
      description: Patch draft metadata before publish.
      operationId: updateCreatorProductDraft
      parameters:
        - $ref: "#/components/parameters/XRequestId"
        - $ref: "#/components/parameters/IdempotencyKeyRequired"
        - in: path
          name: id
          required: true
          description: Product identifier.
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ProductCreateRequest"
      responses:
        "200":
          description: Draft updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductDraftResponse"
        "400":
          $ref: "#/components/responses/ApiError"
        "401":
          $ref: "#/components/responses/ApiError"
        "404":
          $ref: "#/components/responses/ApiError"
        "409":
          $ref: "#/components/responses/ApiError"
        "429":
          $ref: "#/components/responses/ApiError"

  /v1/creator/products/{id}/publish:
    post:
      tags: [Products]
      summary: Publish a product draft
      description: Publish a valid draft to production catalog.
      operationId: publishCreatorProduct
      parameters:
        - $ref: "#/components/parameters/XRequestId"
        - $ref: "#/components/parameters/IdempotencyKeyRequired"
        - in: path
          name: id
          required: true
          description: Product identifier.
          schema:
            type: string
      responses:
        "200":
          description: Product published
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ProductPublishResponse"
              examples:
                success:
                  value:
                    id: prod_01J0NA23WT95D8HMRP6
                    slug: api-draft-model
                    status: PUBLISHED
                    publishedAt: "2026-02-24T18:22:11.000Z"
        "400":
          $ref: "#/components/responses/ApiError"
        "401":
          $ref: "#/components/responses/ApiError"
        "403":
          $ref: "#/components/responses/ApiError"
        "404":
          $ref: "#/components/responses/ApiError"
        "409":
          $ref: "#/components/responses/ApiError"
        "429":
          $ref: "#/components/responses/ApiError"

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer

  parameters:
    XRequestId:
      in: header
      name: X-Request-Id
      required: false
      description: Optional client-generated request ID for traceability.
      schema:
        type: string
    IdempotencyKeyRequired:
      in: header
      name: Idempotency-Key
      required: true
      description: Stable key to guarantee idempotent mutation behavior.
      schema:
        type: string

  responses:
    ApiError:
      description: Standard error envelope
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ErrorEnvelope"
          examples:
            invalidPayload:
              value:
                error:
                  code: invalid_payload
                  message: Payload validation failed.
                  details:
                    - field: title
                      reason: required
                  requestId: req_01J0NB7AX6Q2R0R8D2
                  retryable: false

  schemas:
    PresignUploadRequest:
      type: object
      required: [filename, contentType, size, kind]
      properties:
        filename:
          type: string
        contentType:
          type: string
        size:
          type: integer
          minimum: 1
        kind:
          type: string
          enum: [image, file]

    PresignUploadResponse:
      type: object
      required: [uploadId, storageKey, uploadUrl, expiresAt, maxBytes]
      properties:
        uploadId:
          type: string
        storageKey:
          type: string
        uploadUrl:
          type: string
          format: uri
        expiresAt:
          type: string
          format: date-time
        maxBytes:
          type: integer

    CompleteUploadRequest:
      type: object
      required: [uploadId]
      properties:
        uploadId:
          type: string
        etag:
          type: string
        checksumSha256:
          type: string

    CompleteUploadResponse:
      type: object
      required: [assetId, status, storageKey, size, mime, kind]
      properties:
        assetId:
          type: string
        status:
          type: string
          enum: [READY]
        storageKey:
          type: string
        size:
          type: integer
        mime:
          type: string
        kind:
          type: string
          enum: [image, file]

    UploadStatusResponse:
      type: object
      required: [id, storageKey, filename, size, mime, kind, status, expiresAt, createdAt, updatedAt]
      properties:
        id:
          type: string
        storageKey:
          type: string
        filename:
          type: string
        size:
          type: integer
        mime:
          type: string
        kind:
          type: string
          enum: [image, file]
        status:
          type: string
          enum: [PENDING, READY, FAILED, EXPIRED]
        expiresAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ProductImageInput:
      type: object
      required: [url]
      properties:
        url:
          type: string
        alt:
          type: string

    ProductFileInput:
      type: object
      required: [storageKey, filename, size, mime, kind]
      properties:
        storageKey:
          type: string
        filename:
          type: string
        size:
          type: integer
        mime:
          type: string
        kind:
          type: string
          enum: [Model, Archive, Preview, Support]

    ProductCreateRequest:
      type: object
      required:
        - title
        - category
        - subcategory
        - printMaterials
        - supports
        - difficulty
        - isPresupported
        - license
        - price
        - images
        - files
      properties:
        title:
          type: string
        subtitle:
          type: string
        description:
          type: string
        manufacturingInstructions:
          type: string
        category:
          type: string
        subcategory:
          type: string
        tags:
          type: array
          items:
            type: string
        printMaterials:
          type: array
          items:
            type: string
        supports:
          type: string
          enum: [Required, Optional, None]
        difficulty:
          type: string
          enum: [Easy, Medium, Hard]
        isPresupported:
          type: boolean
        formats:
          type: array
          items:
            type: string
        license:
          type: string
        printTime:
          type: string
        printTimeMinutesMin:
          type: integer
        printTimeMinutesMax:
          type: integer
        price:
          type: number
        allowOffers:
          type: boolean
        images:
          type: array
          items:
            $ref: "#/components/schemas/ProductImageInput"
        files:
          type: array
          items:
            $ref: "#/components/schemas/ProductFileInput"

    ProductDraftResponse:
      type: object
      required: [id, slug, status]
      properties:
        id:
          type: string
        slug:
          type: string
        status:
          type: string
          enum: [DRAFT]

    ProductPublishResponse:
      type: object
      required: [id, slug, status]
      properties:
        id:
          type: string
        slug:
          type: string
        status:
          type: string
          enum: [PUBLISHED]
        publishedAt:
          type: string
          format: date-time
          nullable: true

    ErrorEnvelope:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message, details, requestId, retryable]
          properties:
            code:
              type: string
            message:
              type: string
            details:
              type: array
              items:
                type: object
                properties:
                  field:
                    type: string
                  reason:
                    type: string
            requestId:
              type: string
            retryable:
              type: boolean
            retryAfterSeconds:
              type: integer
